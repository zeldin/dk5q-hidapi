#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include <string.h>
#include <math.h>
#include <sys/time.h>

#include "dk5q.h"

static const uint8_t keyx[256] = {
 0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaf,0xb7,
 0xbf,0xc7,0xd6,0xde,0xe6,0x00,0xf4,0xfe,0x02,0x0a,0x00,0x1f,0x2a,0x35,0x40,0x00,
 0x51,0x5b,0x66,0x71,0x82,0x8d,0x98,0xa2,0xb0,0xbb,0xc6,0xd6,0xde,0xe6,0xf4,0xfe,
 0x02,0x0a,0x15,0x1f,0x2a,0x35,0x40,0x4b,0x56,0x61,0x6c,0x77,0x82,0x8d,0x00,0x9d,
 0xb0,0xbb,0xc6,0xd4,0xde,0xe9,0xf5,0xfd,0x02,0x0c,0x1a,0x25,0x30,0x3b,0x46,0x51,
 0x5b,0x66,0x71,0x7c,0x87,0x92,0x00,0xa0,0xb0,0xbb,0xc6,0xd4,0xde,0xe9,0xf5,0xfd,
 0x02,0x0e,0x00,0x1d,0x28,0x33,0x3d,0x48,0x53,0x5e,0x69,0x74,0x7f,0x8a,0x00,0x95,
 0x00,0x00,0x00,0xd4,0xde,0xe9,0x00,0xfd,0x02,0x0b,0x18,0x23,0x2d,0x38,0x43,0x4e,
 0x59,0x64,0x6f,0x7a,0x84,0x00,0x99,0x99,0x00,0xbb,0x00,0xd4,0xde,0xe9,0x00,0xfd,
 0x02,0x0b,0x19,0x27,0x00,0x00,0x00,0x4f,0x00,0x00,0x00,0x78,0x86,0x93,0x00,0xa1,
 0xb0,0xbb,0xc6,0x00,0xd9,0xe9,0xf5,0xfd,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfd,
 0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfd,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
static const uint8_t keyy[256] = {
 0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa5,0xa5,
 0xa5,0xa5,0x15,0x15,0x15,0x00,0x05,0x05,0x71,0x1d,0x00,0x1d,0x1d,0x1d,0x1d,0x00,
 0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x1d,0x26,0x26,0x26,0x27,0x27,
 0x83,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x00,0x58,
 0x58,0x58,0x58,0x58,0x58,0x58,0x58,0x60,0x94,0x7e,0x7e,0x7e,0x7e,0x7e,0x7e,0x7e,
 0x7e,0x7e,0x7e,0x7e,0x7e,0x7e,0x00,0x90,0x7e,0x7e,0x7e,0x7e,0x7e,0x7e,0x90,0x74,
 0xa5,0xa5,0x00,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0xa5,0x00,0xa5,
 0x00,0x00,0x00,0xa5,0xa5,0xa5,0x00,0x88,0xb6,0xcf,0xcf,0xcf,0xcf,0xcf,0xcf,0xcf,
 0xcf,0xcf,0xcf,0xcf,0xcf,0x00,0xc5,0xd9,0x00,0xcf,0x00,0xcf,0xcf,0xcf,0x00,0x9d,
 0xc8,0xf6,0xf6,0xf6,0x00,0x00,0x00,0xf6,0x00,0x00,0x00,0xf6,0xf6,0xf6,0x00,0xf6,
 0xf6,0xf6,0xf6,0x00,0xf6,0xf6,0xe1,0xb1,0xd9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc5,
 0xea,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xd9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

static uint32_t compute_rainbow(double hprime)
{
  double red = 0, green = 0, blue = 0;
  if (hprime < 1) {
    red = 1;
    green = hprime;
  } else if (hprime < 2) {
    green = 1;
    red = 2 - hprime;
  } else if (hprime < 3) {
    green = 1;
    blue = hprime - 2;
  } else if (hprime < 4) {
    green = 4 - hprime;
    blue = 1;
  } else {
    red = hprime - 4;
    blue = 1;
  }
  uint8_t r = (int)floor(red*255+0.5);
  uint8_t g = (int)floor(green*255+0.5);
  uint8_t b = (int)floor(blue*255+0.5);
  return (r<<16)|(g<<8)|b;
}

int main(int argc, char* argv[])
{
  dk5q_handle handle;

  if (!(handle = dk5q_open(0))) {
    fprintf(stderr, "Failed to open DK5Q\n");
    return EXIT_FAILURE;
  }

  int i;
  uint32_t travel = 0;
  static uint16_t sintab[1024];
  static uint32_t rainbow[3072];
  static uint32_t oldcolor[256];

  for(i=0; i<1024; i++) {
    double n = sin(i * M_PI / 1024.0);
    sintab[i] = (int)floor(n * n * 1024.0 + 0.5);
  }

  memset(rainbow, 0, sizeof(rainbow));
  for(i=0; i<1024; i++) {
    rainbow[1024+i] = compute_rainbow(i*5.0/1024);
  }
  for(i=0; i<100; i++) {
    uint8_t fade = (255*(99-i))/100;
    rainbow[1023-i] = fade<<16;
    rainbow[2048+i] = (fade<<16)|fade;
  }

  memset(oldcolor, ~0, sizeof(oldcolor));

  struct timeval last, now;
  gettimeofday(&last, NULL);

  for(;;) {

    for(i=0; i<256; i++) {
      uint8_t x = keyx[i];
      if (x) {
	uint8_t y = keyy[i];
	uint16_t h = (y << 3) + sintab[((x << 3) + (travel >> 3)) & 1023];
	uint32_t rgb = rainbow[h];
	if (rgb != oldcolor[i]) {
	  oldcolor[i] = rgb;
	  dk5q_set_key_rgb(handle, i, rgb>>16, rgb>>8, rgb, false);
	}
      }
    }

    gettimeofday(&now, NULL);
    int millis = ((int)(now.tv_sec - last.tv_sec))*1000 +
      ((int)(now.tv_usec - last.tv_usec))/1000;

    travel += millis;

    last = now;
  }

  dk5q_close(handle);
  return EXIT_SUCCESS;
}
